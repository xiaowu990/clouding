# 什么是高可用
1. 背景

我们知道在我们使用nginx，代理多态tomcat服务器时，如果某台tomcat服务器发生宕机，那么nginx的分配机制可以自动将其剔除。但是如果发生了nginx的宕机状况，又该如何解决呢。
![[Pasted image 20230731215506.png]]
2. 高可用
高可用（High Availability）是指一个系统、服务或应用程序在发生故障或异常情况时，仍能够保持可用性和正常运行的能力。高可用是现代信息技术系统的重要特性之一，尤其对于对可用性要求较高的关键业务服务来说，高可用性是至关重要的。

实现高可用的关键在于系统的设计和部署方式，通常需要采取以下策略
1. 备份和冗余
2. 负载均衡
3. 故障转移
4. 监控和预警

3. 高可用集群
高可用集群
高可用集群（High Availability Cluster）是指由多个服务器组成的集群，通过协同工作和负载均衡等技术手段，提供高可用性和容错能力的服务。在高可用集群中，每个服务器都运行着相同的软件和服务，并且能够相互通信和协同工作，以确保当一个服务器出现故障或异常时，其他服务器能够接替它的工作，保证服务的连续性和可用性。
![[Pasted image 20230731190239.png]]



4. 高可用集群架构图
下面使用两台Nginx做反向代理服务器，==当其中一台Nginx宕机之后，仍能用另一台来工作，两台Nginx之间用keeplived来监测心跳。==
![[Pasted image 20230731220437.png]]

# 准备工作
两台 Linux 并各自安装 Nginx 和 keepalived
需要两台服务器 192.168.17.129 、192.168.17.131

## 安装keepalived
使用yum命令
yum install keepalived –y
keepalived配置文件所在的目录是：/etc/keepalived/keepalivec.conf 

# 高可用配置（主从配置）
## 配置master
1. 在keepalived中
修改`/etc/keepalived/keepalivec.conf` 配置文件
==这里将原来的配置文件，替换成下面的。==
```C
! Configuration File for keepalived

# 全局定义
global_defs {    

    notification_email {

        acassen@firewall.loc

        failover@firewall.loc

        sysadmin@firewall.loc
     }

        notification_email_from Alexandre.Cassen@firewall.loc

        smtp_server 192.168.17.129

        smtp_connect_timeout 30

        router_id LVS_DEVEL 
# LVS_DEVEL就是主机名字,进入vi /etc/hosts中。添加一个主机名字，例如这里             “127.0.0.1 LVS_DEVEL”
}

# 检测脚本（检测nginx是否还活着）和一些权重参数
vrrp_script chk_http_port {
        script "/usr/local/src/nginx_check.sh" #检测脚本的路径
        interval 2 #（检测脚本执行的间隔）
        weight 2 # 权重
   }
        vrrp_instance VI_1 {
        state MASTER # 主服务器上是MASTER，备份服务器上是BACKUP
        interface eth1 # 网卡，通过ifconfig命令可以查出来
        virtual_router_id 51  # 主、备机的 virtual_router_id 必须相同
        priority 100  # 主、备机取不同的优先级，主机值较大，备份机值较小
        advert_int 1
        authentication {
                auth_type PASS
                auth_pass 1111
        }

        virtual_ipaddress {
             192.168.77.50 # VRRP 虚拟的IP地址
        }

}
```

2. 在nginx中
在`/usr/local/src`添加检测脚本：`nginx_check.sh`
检测nginx是否还活着，如果down机了，则切换到另一个nginx服务器
![[Pasted image 20230731223357.png]]
```C
#!/bin/bash
A=`ps -C nginx –no-header | wc -l`
if [ $A -eq 0 ];then
        /usr/local/nginx/sbin/nginx  #nginx的启动路径
        sleep 2
        if [ `ps -C nginx --no-header |wc -l` -eq 0 ];then
            killall keepalived
        fi
fi
```

## 配置slave
1. 在keepalived中
修改`/etc/keepalived/keepalivec.conf` 配置文件
```C
! Configuration File for keepalived

global_defs {

    notification_email {

        acassen@firewall.loc

        failover@firewall.loc

        sysadmin@firewall.loc 

     }

        notification_email_from Alexandre.Cassen@firewall.loc

        smtp_server 192.168.17.129

        smtp_connect_timeout 30

        router_id LVS_DEVEL 
}


vrrp_script chk_http_port {
        script "/usr/local/src/nginx_check.sh"
        interval 2
        weight 2
   }
        vrrp_instance VI_1 {
        state BACKUP # 修改为从机 BACKUP
        interface eth2 # 修改为从机 ip
        virtual_router_id 51
        priority 90 # 优先级比主机低
        advert_int 1
        authentication {
            auth_type PASS
            auth_pass 1111
        }

        virtual_ipaddress {
            192.168.77.50
        }

}
```

2. 在nginx中
在`/usr/local/src`添加检测脚本（脚本还是一样的）：`nginx_check.sh`
```C
#!/bin/bash
A=`ps -C nginx –no-header | wc -l`
if [ $A -eq 0 ];then
        /usr/local/nginx/sbin/nginx
        sleep 2
        if [ `ps -C nginx --no-header |wc -l` -eq 0 ];then
            killall keepalived
        fi
fi
```

# 启动
## 启动nginx
1. 分别启动主从 Nginx ，切换到`/usr/local/nginx/sbin/`，执行==./nginx==
2. 如果启动过，则选择重启：==./nginx -s reload==
3. 测试nginx是否启动成功：==ps -ef | grep nginx==

![[Pasted image 20230731224049.png]]
## 启动keepalived

1. 启动 keepalived：==systemctl start keepalived.service==
2. 测试 keepalived 是否启动成功
3. ps -ef | grep keepalived

![[Pasted image 20230731224214.png]]

# 测试
![[Pasted image 20230801110256.png]]

1. 在浏览器地址栏输入 虚拟 ip 地址：http://192.168.77.50/
此时便可以通过虚拟 ip 地址访问到 Nginx 。
![[Pasted image 20230731224320.png]]

2. 把主服务器（192.168.77.130）nginx 和 keepalived 停止，再输入 192.168.77.50
此时主机 192.168.77.130 宕机了，从机变为主机。

对keepalived：systemctl stop keepalived.service
对nginx：./nginx -s stop

![[Pasted image 20230731224348.png]]