## 安装与配置
[Download | Prometheus](https://prometheus.io/download/)
在官网下载alertmanager
![[Pasted image 20230817185018.png]]

tar xf alertmanager-0.25.0.linux-amd64.tar.gz
mv alertmanager-0.25.0.linux-amd64 /usr/local/alertmanager

配置文件
vim /usr/lib/systemd/system/alertmanager.service
> 上面的是是个新文件

输入以下内容
```shell
[Unit]
Description=alertmanager System
Documentation=alertmanager System
[Service]
ExecStart=/usr/local/alertmanager/alertmanager \
--config.file=/usr/local/alertmanager/alertmanager.yml
[Install]
WantedBy=multi-user.target
```

systemctl start alertmansger
netstat -lntup:找到alertmanager对应的端口号
处理防火墙端口

![[Pasted image 20230817190744.png]]

验证可知：9093能打开

![[Pasted image 20230817190913.png]]

![[Pasted image 20230817191102.png]]

# 邮件告警
## alertmanager.yml配置文件
这里先备份以下配置文件
cd /usr/local/alertmanager
cp alertmanager.yml alertmanager.yml.backup

进入配置文件:vim alertmanager.yml
             vim /usr/local/alertmanager/alertmanager.yml
输入以下内容

```shell
global: 
  resolve_timeout: 5m 
  smtp_smarthost: 'smtp.163.com:25' 
  smtp_from: 'xxxx@163.com' 
  smtp_auth_username: 'xxxx@163.com' 
  smtp_auth_password: 'ODCLEZECXCFGGGXM' 
  smtp_require_tls: false 
#templates: 
#  - '/usr/local/alertmanager/email.tmpl'
route:
  group_by: ['alertname'] 
  group_wait: 10s 
  group_interval: 10s 
  repeat_interval: 1h 
  receiver: 'email' 
receivers: 
- name: 'email'  
  email_configs:
  - to: 'alertest@163.com'
 #   html: '{{ template "email.to.html" . }}' 
    send_resolved: true  
inhibit_rules: 
  - source_match: 
      severity: 'critical' 
    target_match: 
      severity: 'warning' 
    equal: ['alertname', 'dev', 'instance']
```

==*smtp_auth_password是授权码，即邮箱开启POP3/SMTP服务的密码，不是登录密码*==
![[Pasted image 20230817200209.png]]


==smtp服务器的地址和端口==

![[Pasted image 20230817201454.png]]

![[Pasted image 20230817201700.png]]


==注释版==
配置文件注解，官方介绍：https://prometheus.io/docs/alerting/latest/configuration/
```shell
global:					#全局配置：指定所有其他配置上下文中有效的参数，作为其他配置部分的默认值
resolve_timeout: 5m		#alertmanager持续多长时间未接收到告警后标记告警状态为 resolved
以下配置邮件发送信息
smtp_smarthost: 'smtp.163.com:465'       #发送邮件的SMTP主机
smtp_from: 'yrnhhh@163.com'              #邮箱地址
smtp_auth_username: 'yhhh@163.com'       #邮箱地址,登录用户
smtp_auth_password: 'XXXXXXXXXXXXXXXX'   #授权码
smtp_hello: '163.com'					 #识别SMTP服务器的默认主机名
smtp_require_tls: false					 #是否加密连接
 
route 					                 #配置分发路由
group_by: ['alertname', 'cluster']       #这里标签列表用于分组，同标签值会被聚合到一个分组里
group_wait: 30s							 #初始化通知
group_interval: 30s						 #相同的group之间发送告警通知的时间间隔
repeat_interval: 1h						 #如果一个报警信息已发送成功，等待重新发送他们的时间
receiver: default						 #默认接收器，如报警没有被route匹配，则会发送给默认的接收器
routes:									 #上面所有的属性都由所有子路由继承，并且可以在每个子路由上进行覆盖
- receiver: email
  group_wait: 10s
  match:
   team: node
receivers:								 #定义告警邮件接收者
- name: 'default'
  email_configs:
  - to: '1234567890@qq.com'
    send_resolved: true					 #接受告警恢复的通知
- name: 'email'
  email_configs:
  - to: '0987654321@qq.com'
    send_resolved: true
```

检查配置
./amtool check-config alertmanager.yml
如果效果如下，则说明配置没问题
![[Pasted image 20230817201851.png]]

重启alertmanager
systemctl restart alertmanager

## prometheus.yml配置文件
vim /usr/local/prometheus/prometheus.yml

```
- rules/*.yml
```


![[Pasted image 20230817211542.png]]
## 编写告警规则
cd /usr/local/prometheus
mkdir rules
cd rules
创建一个主机的配置文件
vim host_monitor.yml
一步到位：vim /usr/local/prometheus/rules/host_monitor.yml
下面内容输入后，==就重启一下prometheus和alertmanager==

```shell
groups: 
- name: node-up
  rules:
  - alert: node-up
    expr: up == 0
    for: 7s
    labels:
      team: node
    annotations:
      summary: "{{$labels.instance}}Instance has been down for more than 5 minutes"
```

* alert：告警规则的名称。 
* expr：基于 PromQL 表达式告警触发条件，用于计算是否有时间序列满足该条件。 
* for：评估等待时间，可选参数。用于表示只有当触发条件持续一段时间后才发送告警。在 等待期间新产生告警的状态为 pending。 
* labels：自定义标签，允许用户指定要附加到告警上的一组附加标签。
* annotations：用于指定一组附加信息，比如用于描述告警详细信息的文字等，annotations 的内容在告警产生时会一同作为参数发送到 Alertmanager。 
* summary 描述告警的概要信息，description 用于描述告警的详细信息。
* 同时 Alertmanager 的 UI 也会根据这两个标签值，显示告警信息。

## 验证测试
![[Pasted image 20230817210211.png]]
停掉node来触发告警:systemctl stop node_exporter

![[Pasted image 20230817210828.png]]

![[Pasted image 20230817210844.png]]

状态说明 
Prometheus Alert 告警状态有三种状态：Inactive、Pending、Firing。 
1、Inactive：非活动状态，表示正在监控，但是还未有任何警报触发。 
2、Pending：表示这个警报必须被触发。由于警报可以被分组、压抑/抑制或静默/静音，所 以等待验证，一旦所有的验证都通过，则将转到 Firing 状态。 
3、Firing：将警报发送到 AlertManager，它将按照配置将警报的发送给所有接收者。一旦警 报解除，则将状态转到 Inactive，如此循环


邮箱收到，代表成功了
![[Pasted image 20230817211943.png]]


## 优化告警模板
使用vim新建并打开配置文件：
vim /usr/local/alertmanager/email.tmpl
输入以下内容
```shell
{{ define "email.to.html" }} 
{{ range .Alerts }} 
 =========start==========<br> 
告警程序: prometheus_alert <br>
告警级别: {{ .Labels.severity }} 级 <br>
告警类型: {{ .Labels.alertname }} <br>
故障主机: {{ .Labels.instance }} <br>
告警主题: {{ .Annotations.summary }} <br>
告警详情: {{ .Annotations.description }} <br>
触发时间: {{ .StartsAt }} <br>
=========end==========<br>
{{ end }} 
{{ end }}
```
![[Pasted image 20230818085256.png]]

然后重启一下prometheus和alertmanager

![[Pasted image 20230818091622.png]]


## 告警的标签-路由-分组


