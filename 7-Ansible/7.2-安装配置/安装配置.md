# 安装
## rpm包安装方式
```shell
# Centso 需要设置EPEL仓库
[root@ansible_server~]# yum install epel-release

# 使用yum 安装ansible 
[root@ansible_server~]# yum install ansible

# 查看ansible 安装版本
[root@ansible_server~]# ansible --version
ansible 2.9.25
  config file = /etc/ansible/ansible.cfg
  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python2.7/site-packages/ansible
  executable location = /usr/bin/ansible
  python version = 2.7.5 (default, Oct 30 2018, 23:45:53) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]
```

![[Pasted image 20230809225754.png]]


> 查看ansible中包含的文件列表：rpm -ql ansible | less
> 查看模块的file文件：rpm -ql ansible | grep file.py

## 编译方式安装

```shell
yum -y install python-jinja2 PyYAML python-paramiko python-babel
python-crypto
tar xf ansible-1.5.4.tar.gz
cd ansible-1.5.4
python setup.py build
python setup.py install
mkdir /etc/ansible
cp -r examples/* /etc/ansible
```

## Git方式反转
```shell
git clone git://github.com/ansible/ansible.git --recursive
cd ./ansible
source ./hacking/env-setup
```

## pip安装
pip是安装Python包的管理器，类似yum
```shell
yum install python-pip python-devel
yum install gcc glibc-devel zibl-devel rpm-bulid openssl-devel
pip install --upgrade pip
pip install ansible --upgrade
```

# 配置说明

## Ansible的文件目录
```shell
/etc/ansible/ansible.cfg  主配置文件,配置ansible工作特性(一般无需修改)
/etc/ansible/hosts        主机清单(将被管理的主机放到此文件)
/etc/ansible/roles/       存放角色的目录 # 默认路径，可以修改
```

![[Pasted image 20230810202223.png]]
## Ansible工具

```shell
/usr/bin/ansible          主程序，临时命令执行工具
/usr/bin/ansible-doc      查看配置文档，模块功能查看工具 # 1000+的模块的使用说明
/usr/bin/ansible-galaxy   下载/上传优秀代码或Roles模块的官网平台
/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具
/usr/bin/ansible-pull     远程执行命令的工具
/usr/bin/ansible-vault    文件加密工具
/usr/bin/ansible-console  基于Console界面与用户交互的执行工具
```

![[Pasted image 20230810202625.png]]

## 配置文件
配置文件：/etc/ansible/ansible.cfg 一般保持默认配置
### defaults默认配置
- ansible在执行命令时，会将命令转换为python脚本生成在本地local_tmp，然后传递到远程服务器的临时目录remote_tmp
- 命令执行完成后，删除对应的python命令文件
- forks 表示并发执行的次数，同时可以给5台机器发送指令

```shell
[defaults]
#inventory     = /etc/ansible/hosts      # 主机列表配置文件
#library       = /usr/share/my_modules/  # 库文件存放目录
#remote_tmp    = $HOME/.ansible/tmp      # 临时py命令文件存放在远程主机目录
#local_tmp     = $HOME/.ansible/tmp      # 本机的临时命令执行目录  
#forks         = 5                       # 默认并发数,同时可以执行5次
#sudo_user     = root                    # 默认sudo用户
#ask_sudo_pass = True                    # 每次执行ansible命令是否询问ssh密码
#ask_pass      = True                    # 每次执行ansible命令是否询问ssh口令
#remote_port   = 22                      # 远程主机的端口号(默认22)

```
建议优化项

- host_key_checking 如果开启，每次需要在`known_host`中先与其他主机建立一下链接的询问
- 默认情况下 ansible是不记录日志的，需要开启日志配置

![[Pasted image 20230810094746.png]]

![[Pasted image 20230810095215.png]]

![[Pasted image 20230810094950.png]]

![[Pasted image 20230810095756.png]]


![[Pasted image 20230810095809.png]]

![[Pasted image 20230810101057.png]]
# 主机清单
##  基本配置
> ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可在inventory file中将其分组命名

主机清单定义：主机清单（Inventory）是Ansible中用于管理和定义被控端主机及其组织结构的配置文件。它是一个文本文件（通常是INI格式或YAML格式），包含了要被Ansible管理的主机和主机组的信息。

分组：使用中括号：“[]”,组名自定义，每个组包含多个被管理主机；同时一个被管理主机可以属于多个不同的组。分组在主机清单中的作用是将相似特征或用途的主机归类到一起，以便进行统一的操作和管理。不分组也可以。

- 默认的inventory file在/etc/ansible/hosts 
- inventory file可以有多个，且也可以通过==Dynamic Inventory==来动态生成

>Dynamic Inventory（动态清单）是 Ansible 中一种特殊类型的主机清单，它允许在运行时动态生成主机清单，而不是使用静态清单文件。与静态清单不同，动态清单可以基于外部数据源（如云平台 API、配置管理数据库等）或自定义脚本生成主机清单。

- 文件格式：inventory文件遵循INI文件风格，中括号中的字符为组名
    - 可将同一个主机同时归并到多个不同的组中
    - 若目标主机使用了非默认的SSH端口，可在主机名称之后使用冒号加端口号来标明

步骤，进入主机清单文件中添加即可（原本的主机清单是空的，都是注释）
![[Pasted image 20230810212042.png]]

![[Pasted image 20230810212001.png]]


## 分组配置
```shell
[webservers]     #webservers组
www1.stt.com:2222  #可以指定端口
www2.stt.com

[dbservers]
db1.stt.com
db2.stt.com
db3.stt.com

[websrvs]
192.168.10.10[2:4]    #表示102-104范围内的ip

[dbsrvs]
db-[a:f].example.com  #表示范围dba-dbf
```

##  组嵌套
```shell
[apache]
httpd1.stt.com
httpd2.stt.com

[nginx]
ngx1.stt.com
ngx2.stt.com

[websrvs:children] # 将上面2个组进行组合
apache
nginx
```

> ansible中的ping不是协议，是一个模块，走的还是ssh协议

